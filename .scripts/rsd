#!/usr/bin/python

import paramiko, dialog, os, sys, stat, time, subprocess

def getf(d, s, fn):
    if sys.argv[-1] == '-i':
        bleg = 'incomplete'
    else:
        bleg = 'complete'
    try:
        limit = str(int(sys.argv[1]))
    except:
        limit = '1500'
    subprocess.check_call([
        'rsync', '-rPz4t', '--bwlimit', limit, '--inplace',
        '--exclude', '*r[0123456789][0123456789]',
        '--exclude', 'Sample',
        'rsync://ninjacomputer.com:8873/%s/%s' % (bleg, fn), '.'])
    subprocess.check_call([
        'rsync', '-rPz4t', '--bwlimit', limit, '--inplace', '--chmod=+rX',
        'rsync://ninjacomputer.com:8873/%s/%s' % (bleg, fn), '.'])


def nuke(s, fn):
    print 'Removing ' + fn
    st = s.stat(fn)
    if stat.S_ISDIR(st.st_mode):
        ls = sorted(s.listdir(fn))
        for subfn in ls:
            nuke(s, os.path.join(fn, subfn))
        s.rmdir(fn)
    else:
        s.remove(fn)

try:
    d = dialog.Dialog()
    c = paramiko.SSHClient()
    c.load_system_host_keys()
    c.connect('ninjacomputer.com', username='steven')
    s = c.open_sftp()
    print sys.argv
    if sys.argv[-1] == '-i':
        s.chdir('/home/steven/d/i')
    else:
        s.chdir('/home/steven/d/c')
    ls = s.listdir()
    if len(ls) == 0:
        print ("No files in remote directory!")
        sys.exit(0)
    ls.sort()
    choices = []
    for i in range(len(ls)):
        choices.append((repr(i), ls[i], 0))
    print choices
    (exit, selected) = d.checklist(text="Select a file / directory",
                                   list_height = 15, choices = choices,
                                   width = 90, height = 22)

    for i_s in selected:
        i = int(i_s)
        getf(d, s, ls[i])
        if sys.argv[-1] != '-i':
            nuke(s, ls[i])

except:
    c.close()
    raise

c.close()
sys.exit(0)

